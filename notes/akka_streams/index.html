<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Actor Streams leverage the actor system to consume streams of data. In fact, each element of a stream is a Message within the Actor System
Here, data flows through a chain of processing stages:
 Sources: The &ldquo;source&rdquo; (e.g., CSV file). Sinks: The &ldquo;destination&rdquo; (e.g., a file). Flows: Transformations made to the data within the Stream (e.g., total number of lines). Runnable Graphs: A stream where all inputs and outputs are connected."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Akka Streams"><meta property="og:description" content="Actor Streams leverage the actor system to consume streams of data. In fact, each element of a stream is a Message within the Actor System
Here, data flows through a chain of processing stages:
 Sources: The &ldquo;source&rdquo; (e.g., CSV file). Sinks: The &ldquo;destination&rdquo; (e.g., a file). Flows: Transformations made to the data within the Stream (e.g., total number of lines). Runnable Graphs: A stream where all inputs and outputs are connected."><meta property="og:type" content="article"><meta property="og:url" content="https://bphenriques.github.io/knowledge-base/notes/akka_streams/"><meta property="article:section" content="notes"><title>Akka Streams | Bruno Henriques's Digital Garden ðŸŒ±</title><link rel=icon href=/knowledge-base/favicon.png type=image/x-icon><link rel=stylesheet href=/knowledge-base/scss/explorer.min.fff1aaee6fb1e5a74069ac1205647344fa7bf178f7f20b3abcf095b18d0c24fe.css integrity="sha256-//Gq7m+x5adAaawSBWRzRPp78Xj38gs6vPCVsY0MJP4=" crossorigin=anonymous><script defer src=/knowledge-base/js/vendor/flexsearch.bundle.js></script><script defer src=/knowledge-base/js/search.min.73a19291761c071ff78abc5f5899d810691d46b13c6f658e86fac38510727b52.js integrity="sha256-c6GSkXYcBx/3irxfWJnYEGkdRrE8b2WOhvrDhRBye1I=" crossorigin=anonymous></script><script defer src=/knowledge-base/js/clipboard.min.14b9ccf5803971502776b44d95026b084e5fa02a544dc0e4cd86a7db76f691b2.js integrity="sha256-FLnM9YA5cVAndrRNlQJrCE5foCpUTcDkzYan23b2kbI=" crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=site-menu-control>
<input type=checkbox class="hidden toggle" id=content-menu-control><main class="container flex"><aside class=site-menu><div class=site-menu-content><nav><h2 class=brand><a class="flex align-center" href=/knowledge-base/><span>Bruno Henriques</span></a></h2><div class=search><input type=text id=search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="search-spinner hidden"></div><ul id=search-results class=item-preview-list></ul></div><a class=site-menu-shortcut-link href=/knowledge-base/notes>Recent Notes</a><p class=site-menu-tags-title><b>Tags</b></p><ul><li><a class=list-tag-item href=/knowledge-base/tags/akka><div class=tag-dot style=background-color:#ffecb3></div>Akka</a></li><li><a class=list-tag-item href=/knowledge-base/tags/concurrency><div class=tag-dot style=background-color:#f5f5f5></div>Concurrency</a></li><li><a class=list-tag-item href=/knowledge-base/tags/data><div class=tag-dot style=background-color:#ffe0b2></div>Data</a></li><li><a class=list-tag-item href=/knowledge-base/tags/data-structures><div class=tag-dot style=background-color:#ffcdd2></div>Data structures</a></li><li><a class=list-tag-item href=/knowledge-base/tags/databases><div class=tag-dot style=background-color:#f1f8e9></div>Databases</a></li><li><a class=list-tag-item href=/knowledge-base/tags/dispatcher><div class=tag-dot style=background-color:#c8e6c9></div>Dispatcher</a></li><li><a class=list-tag-item href=/knowledge-base/tags/editors><div class=tag-dot style=background-color:#ffb74d></div>Editors</a></li><li><a class=list-tag-item href=/knowledge-base/tags/fp><div class=tag-dot style=background-color:#80cbc4></div>Fp</a></li><li><a class=list-tag-item href=/knowledge-base/tags/functional-programming><div class=tag-dot style=background-color:#ffebee></div>Functional programming</a></li><li><a class=list-tag-item href=/knowledge-base/tags/io><div class=tag-dot style=background-color:#ffd180></div>Io</a></li><li><a class=list-tag-item href=/knowledge-base/tags/jq><div class=tag-dot style=background-color:#e1f5fe></div>Jq</a></li><li><a class=list-tag-item href=/knowledge-base/tags/json><div class=tag-dot style=background-color:#ffebee></div>JSON</a></li><li><a class=list-tag-item href=/knowledge-base/tags/jvm><div class=tag-dot style=background-color:#90caf9></div>Jvm</a></li><li><a class=list-tag-item href=/knowledge-base/tags/kotlin><div class=tag-dot style=background-color:#ffe57f></div>Kotlin</a></li><li><a class=list-tag-item href=/knowledge-base/tags/lightbend><div class=tag-dot style=background-color:#f0f4c3></div>Lightbend</a></li><li><a class=list-tag-item href=/knowledge-base/tags/monitoring><div class=tag-dot style=background-color:#e3f2fd></div>Monitoring</a></li><li><a class=list-tag-item href=/knowledge-base/tags/note><div class=tag-dot style=background-color:#bbdefb></div>Note</a></li><li><a class=list-tag-item href=/knowledge-base/tags/protocols><div class=tag-dot style=background-color:#ab9df2></div>Protocols</a></li><li><a class=list-tag-item href=/knowledge-base/tags/psql><div class=tag-dot style=background-color:#e0f2f1></div>Psql</a></li><li><a class=list-tag-item href=/knowledge-base/tags/queue><div class=tag-dot style=background-color:#ffebee></div>Queue</a></li><li><a class=list-tag-item href=/knowledge-base/tags/reference><div class=tag-dot style=background-color:#00bfa5></div>Reference</a></li><li><a class=list-tag-item href=/knowledge-base/tags/router><div class=tag-dot style=background-color:#c8e6c9></div>Router</a></li><li><a class=list-tag-item href=/knowledge-base/tags/scala><div class=tag-dot style=background-color:#ffd180></div>Scala</a></li><li><a class=list-tag-item href=/knowledge-base/tags/security><div class=tag-dot style=background-color:#b3e5fc></div>Security</a></li><li><a class=list-tag-item href=/knowledge-base/tags/signing><div class=tag-dot style=background-color:#ffd866></div>Signing</a></li><li><a class=list-tag-item href=/knowledge-base/tags/snippets><div class=tag-dot style=background-color:#e1f5fe></div>Snippets</a></li><li><a class=list-tag-item href=/knowledge-base/tags/stream><div class=tag-dot style=background-color:#d1c4e9></div>Stream</a></li><li><a class=list-tag-item href=/knowledge-base/tags/system-design><div class=tag-dot style=background-color:#ffebee></div>System design</a></li><li><a class=list-tag-item href=/knowledge-base/tags/uncategorized><div class=tag-dot style=background-color:#90caf9></div>Uncategorized</a></li><li><a class=list-tag-item href=/knowledge-base/tags/work><div class=tag-dot style=background-color:#f5f5f5></div>Work</a></li><li><a class=list-tag-item href=/knowledge-base/tags/zettelkasten><div class=tag-dot style=background-color:#e3f2fd></div>Zettelkasten</a></li></ul></nav></div></aside><div class=page><header class=mobile-navigation-header><div class="flex align-center justify-between"><label for=site-menu-control><img src=/knowledge-base/svg/menu-page.svg class=icon alt="Page Menu"></label>
<strong>Akka Streams</strong>
<label for=content-menu-control><img src=/knowledge-base/svg/menu-content.svg class=icon alt="Content Menu"></label></div></header><article class=markdown><h1 class=post-title><a href=/knowledge-base/notes/akka_streams/>Akka Streams</a></h1><p>Actor Streams leverage the actor system to consume streams of data. In fact, each element of a stream is a Message within the Actor System</p><p>Here, data flows through a chain of processing stages:</p><ul><li><code>Sources</code>: The &ldquo;source&rdquo; (e.g., CSV file).</li><li><code>Sinks</code>: The &ldquo;destination&rdquo; (e.g., a file).</li><li><code>Flows</code>: Transformations made to the data within the Stream (e.g., total number of lines).</li><li><code>Runnable Graphs</code>: A stream where all inputs and outputs are connected.</li></ul><p>All these stages are composable and, in order to start the flow they have to be materialized. As soon they are connected, each staga materializes a value. See available operators <a href=https://doc.akka.io/docs/akka/current/stream/operators/>here</a>
.</p><p>Moreover, there are two types of Streams:</p><ul><li><code>Linear Streams</code>: Linear flow.</li><li><code>Graphs</code>: Where there may be branches points in the Stream (aka <code>Junctions</code>). Useful for more complex use-cases.</li></ul><p>In any case, by default the stages in a <code>Linear Stream</code> run <strong>syncronously</strong> inside a single together (&ldquo;Fused&rdquo; together) but can also be configured to run <code>asyncronously</code> in separate actors.</p><p>Last but not he least: backpressure is managed by a pull/push mechanism. I.e.:</p><ol><li>Subscriber signals demand which is sent upstream via subscription.</li><li>Publishers receives demand and pushes data (if available) downstream.</li></ol><h2 id=source>Source
<a class=anchor href=#source>#</a></h2><p>Stage with single output: <code>Source[+Out, +Mat]</code>:</p><ul><li><code>Out</code>: The type of each element that is produced.</li><li><code>Mat</code>: Type of the materialized value. Usually <code>NotUsed</code>.</li></ul><p>Source only push data as long as there is demand. The source will have to deal with incoming data until demand resumes (how how largely demands on the use-case).</p><p>See available operators <a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#source-operators>here</a>
.</p><h2 id=sink>Sink
<a class=anchor href=#sink>#</a></h2><p>Stage with a single input: <code>Sink[-In, +Mat]</code>:</p><ul><li>In: The type of each element that is consumed.</li><li>Mat The type of each element that is produced. E.g., Future[Int].</li></ul><p>It creates backpressure by controlling <em>Demand</em>. Note that if the stream is infinite, these sinks may never complete.</p><p>See available operators <a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#sink-operators>here</a>
.</p><h2 id=flows>Flows
<a class=anchor href=#flows>#</a></h2><p>Single input and single output: <code>Flow[-In, +Out, +Mat]</code>.</p><p>Acts both as producer and consumer therefore it propagates demand to the producer as well propagating (and transforming) messages produced to downstream stages.</p><p>The most notable operators (way too many):</p><ul><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#simple-operators>Simple Operators</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#timer-driven-operators>Timer Driven</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#asynchronous-operators>Asyncronous</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#backpressure-aware-operators>Backpressure Aware</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#nesting-and-flattening-operators>Nesting and flatenning</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#time-aware-operators>Time Aware</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#fan-in-operators>Fan-in</a></li><li><a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#fan-out-operators>Fan-Out</a></li></ul><p>Note that some of these operations are directly accessible from <code>Source</code> and does not require additional typing.</p><p>Additional notes:</p><ul><li><code>Buffer</code> smooths flow inconsistencies.</li><li><code>extrapolate</code> to deal with slow producers.</li><li><code>batch</code> to deal with slow consumers.</li><li><code>conflate</code> which creates a summary of the elements when the producer is faster - What is the usefulness?</li></ul><h2 id=runnable-graphs>Runnable Graphs
<a class=anchor href=#runnable-graphs>#</a></h2><p>Connects source, flows and sinks so that data can start flowing.</p><p>This is done using <code>via</code> followed <code>to</code> and finally <code>run</code> on a <code>Source</code> as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-actor:2.6.3`
<span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-stream:2.6.3`

<span style=color:#66d9ef>import</span> akka.actor.ActorSystem
<span style=color:#66d9ef>import</span> akka.stream.scaladsl.<span style=color:#f92672>{</span><span style=color:#a6e22e>Flow</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Sink</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Source</span><span style=color:#f92672>}</span>

<span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> system <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>ActorSystem</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;QuickStart&#34;</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>Source</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> to <span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
   <span style=color:#f92672>.</span>via<span style=color:#f92672>(</span><span style=color:#a6e22e>Flow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>].</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>
   <span style=color:#f92672>.</span>to<span style=color:#f92672>(</span><span style=color:#a6e22e>Sink</span><span style=color:#f92672>.</span>foreach<span style=color:#f92672>(</span>println<span style=color:#f92672>))</span>
   <span style=color:#f92672>.</span>run
</code></pre></div><p>Notes:</p><ul><li><code>via</code>: connects <code>Flow</code> to a <code>Source</code> returning a new <code>Source</code>. Also allows composing two <code>Flows</code>.</li><li><code>to</code>: connects a <code>Sink</code> to a <code>Source</code> returning a <code>RunnableGraph</code>. Also connects to a <code>Flow</code> to build new <code>Sink</code>. In essence, it materializes the value from the stage is called on.</li><li>The <code>run</code> is a terminal operator. There are others.</li></ul><p>While the flow is <strong>running</strong>, values are materialized. These values are then acessed using <code>to</code>, <code>source.toMat(Sink)(Transform/CombineFunction)</code>, <code>~source.viaMat(flow)(Transform/CombineFunction)</code>.</p><p>Finally, there are some shortcuts:</p><ul><li><code>Source.runWith(Sink)</code>.</li><li><code>Source.runForeach(Function)</code>.</li><li><code>Source.runFold(0)(_ + _)</code>.</li><li><code>Source.runReduce(_ + _).</code></li></ul><h2 id=fault-tolerancy-todo-review-examples>Fault Tolerancy - TODO: Review Examples
<a class=anchor href=#fault-tolerancy-todo-review-examples>#</a></h2><p>Default strategy is to stop processing the stream and can be overriden within the <code>ActorMaterializer</code> by passing a decider that given an exception it either decides:</p><ul><li><em>Stop</em>: terminate with an error.</li><li><em>Resume</em>: Drop the failing element.</li><li><em>Restart</em>: The element is dropped and the stream continues after restarting the stage. Any state acumulated by that stage will be cleared.</li></ul><p>Via attributes, each stage can be fine-tuned:</p><ul><li><code>Dispatcher</code></li><li><code>Buffer Sizes</code></li><li><code>Log Level</code></li><li><code>Supervision</code></li></ul><p>With a Supervision Strategy:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-actor:2.6.3`
<span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-stream:2.6.3`

<span style=color:#66d9ef>import</span> akka.NotUsed
<span style=color:#66d9ef>import</span> akka.actor.ActorSystem
<span style=color:#66d9ef>import</span> akka.stream.<span style=color:#f92672>{</span><span style=color:#a6e22e>ActorAttributes</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Supervision</span><span style=color:#f92672>}</span>
<span style=color:#66d9ef>import</span> akka.stream.scaladsl.<span style=color:#f92672>{</span><span style=color:#a6e22e>Flow</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Sink</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Source</span><span style=color:#f92672>}</span>
<span style=color:#66d9ef>import</span> java.lang.ArithmeticException

<span style=color:#66d9ef>val</span> decider<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Supervision.Decider</span> <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_:</span> <span style=color:#66d9ef>ArithmeticException</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Supervision</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Resume</span>
  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#a6e22e>Supervision</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Stop</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>val</span> possibleDivisionByZero <span style=color:#66d9ef>=</span>
  <span style=color:#a6e22e>Flow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>].</span>map<span style=color:#f92672>(</span>i <span style=color:#66d9ef>=&gt;</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>/</span> i<span style=color:#f92672>)</span>
    <span style=color:#f92672>.</span>withAttributes<span style=color:#f92672>(</span>
      <span style=color:#a6e22e>ActorAttributes</span><span style=color:#f92672>.</span>supervisionStrategy<span style=color:#f92672>(</span>decider<span style=color:#f92672>)</span>
    <span style=color:#f92672>)</span>

<span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> system <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>ActorSystem</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;QuickStart&#34;</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>Source</span><span style=color:#f92672>(-</span><span style=color:#ae81ff>1</span> to <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
   <span style=color:#f92672>.</span>via<span style=color:#f92672>(</span>possibleDivisionByZero<span style=color:#f92672>)</span>
   <span style=color:#f92672>.</span>runWith<span style=color:#f92672>(</span><span style=color:#a6e22e>Sink</span><span style=color:#f92672>.</span>foreach<span style=color:#f92672>(</span>println<span style=color:#f92672>))</span>
</code></pre></div><p>However some errors are recoverable, in this case we provide a <code>PartialFunction[Throwable, T]</code>. It will terminate the stream graciously passing the resulting value as the final value.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-actor:2.6.3`
<span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-stream:2.6.3`

<span style=color:#66d9ef>import</span> akka.NotUsed
<span style=color:#66d9ef>import</span> akka.actor.ActorSystem
<span style=color:#66d9ef>import</span> akka.stream.<span style=color:#f92672>{</span><span style=color:#a6e22e>ActorAttributes</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Supervision</span><span style=color:#f92672>}</span>
<span style=color:#66d9ef>import</span> akka.stream.scaladsl.<span style=color:#f92672>{</span><span style=color:#a6e22e>Flow</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Sink</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Source</span><span style=color:#f92672>}</span>
<span style=color:#66d9ef>import</span> java.lang.ArithmeticException

<span style=color:#66d9ef>val</span> possibleDivisionByZero <span style=color:#66d9ef>=</span>
  <span style=color:#a6e22e>Flow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>].</span>map<span style=color:#f92672>(</span>i <span style=color:#66d9ef>=&gt;</span> <span style=color:#ae81ff>100</span><span style=color:#f92672>/</span>i<span style=color:#f92672>)</span>
    <span style=color:#f92672>.</span>withAttributes<span style=color:#f92672>(</span>
      <span style=color:#a6e22e>ActorAttributes</span><span style=color:#f92672>.</span>supervisionStrategy<span style=color:#f92672>(</span>decider<span style=color:#f92672>)</span>
    <span style=color:#f92672>)</span>
    <span style=color:#f92672>.</span>recover <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_:</span> <span style=color:#66d9ef>ArithmeticException</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>0</span>
    <span style=color:#f92672>}</span>

<span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> system <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>ActorSystem</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;QuickStart&#34;</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>Source</span><span style=color:#f92672>(-</span><span style=color:#ae81ff>1</span> to <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
   <span style=color:#f92672>.</span>via<span style=color:#f92672>(</span>possibleDivisionByZero<span style=color:#f92672>)</span>
   <span style=color:#f92672>.</span>runWith<span style=color:#f92672>(</span><span style=color:#a6e22e>Sink</span><span style=color:#f92672>.</span>foreach<span style=color:#f92672>(</span>println<span style=color:#f92672>))</span>
</code></pre></div><h2 id=graphs>Graphs
<a class=anchor href=#graphs>#</a></h2><p>Introduces <code>Junctions</code> which take multiple inputs and multiple outputs. Basic ones are:</p><ul><li><code>Fan-in</code>: N inputs + 1 output. See <a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#fan-in-operator>operators</a>
.</li><li><code>Fan-out</code>: 1 input + N outputs. See <a href=https://doc.akka.io/docs/akka/current/stream/operators/index.html#fan-out-operators>operators</a>
.</li></ul><p>For example, using <code>Fan-in</code> we can randombly select one of the inputs, give preference or merely zip them. Then, using <code>Fan-out</code>, we can broadcast the values or unzip to create two individual streams.</p><figure><img src=ox-hugo/_20201014_220602screenshot.png></figure><p>We can use <code>GraphDSL</code> to easily connect them visually (<a href=https://doc.akka.io/docs/akka/current/stream/stream-graphs.html>documentation</a>
). E.g.:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-actor:2.6.3`
<span style=color:#66d9ef>import</span> $ivy.`com.typesafe.akka::akka-stream:2.6.3`

<span style=color:#66d9ef>import</span> akka.NotUsed
<span style=color:#66d9ef>import</span> akka.actor.ActorSystem
<span style=color:#66d9ef>import</span> akka.stream.<span style=color:#f92672>{</span><span style=color:#a6e22e>ActorAttributes</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>ClosedShape</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Supervision</span><span style=color:#f92672>}</span>
<span style=color:#66d9ef>import</span> akka.stream.scaladsl.<span style=color:#f92672>{</span><span style=color:#a6e22e>Broadcast</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Flow</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Merge</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>RunnableGraph</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Sink</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Source</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>GraphDSL</span><span style=color:#f92672>}</span>

<span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>val</span> system <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>ActorSystem</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;QuickStart&#34;</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>RunnableGraph</span><span style=color:#f92672>.</span>fromGraph<span style=color:#f92672>(</span><span style=color:#a6e22e>GraphDSL</span><span style=color:#f92672>.</span>create<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> <span style=color:#66d9ef>implicit</span> builder<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>GraphDSL.Builder</span><span style=color:#f92672>[</span><span style=color:#66d9ef>NotUsed</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=&gt;</span>
  <span style=color:#66d9ef>import</span> GraphDSL.Implicits._
  <span style=color:#66d9ef>val</span> in <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Source</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span> to <span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>
  <span style=color:#66d9ef>val</span> out <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Sink</span><span style=color:#f92672>.</span>foreach<span style=color:#f92672>(</span>println<span style=color:#f92672>)</span>

  <span style=color:#66d9ef>val</span> bcast <span style=color:#66d9ef>=</span> builder<span style=color:#f92672>.</span>add<span style=color:#f92672>(</span><span style=color:#a6e22e>Broadcast</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>](</span><span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>
  <span style=color:#66d9ef>val</span> merge <span style=color:#66d9ef>=</span> builder<span style=color:#f92672>.</span>add<span style=color:#f92672>(</span><span style=color:#a6e22e>Merge</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>](</span><span style=color:#ae81ff>2</span><span style=color:#f92672>))</span>

  <span style=color:#66d9ef>val</span> f1<span style=color:#f92672>,</span> f2<span style=color:#f92672>,</span> f3<span style=color:#f92672>,</span> f4 <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Flow</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Int</span><span style=color:#f92672>].</span>map<span style=color:#f92672>(</span><span style=color:#66d9ef>_</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span><span style=color:#f92672>)</span>

  in <span style=color:#f92672>~&gt;</span> f1 <span style=color:#f92672>~&gt;</span> bcast <span style=color:#f92672>~&gt;</span> f2 <span style=color:#f92672>~&gt;</span> merge <span style=color:#f92672>~&gt;</span> f3 <span style=color:#f92672>~&gt;</span> out
  bcast <span style=color:#f92672>~&gt;</span> f4 <span style=color:#f92672>~&gt;</span> merge
  <span style=color:#a6e22e>ClosedShape</span>                 <span style=color:#75715e>// Indicates no open inputs or outputs, this means that the graph is runnable. The opposite means that it is a partial graph.
</span><span style=color:#75715e></span><span style=color:#f92672>}).</span>run<span style=color:#f92672>()</span>
</code></pre></div><p>It is also possible to build partial graphs, or <code>Shapes</code>. There are already some built-in:</p><ul><li>Linear Shapes (<code>&lt;Source|Flow|Sink>Shape</code>)</li><li>Junction Shapes with the same input/output types (<code>UniformFan&lt;In|Out>Shape</code>).</li><li>Junction Shapes with different inputs/outputs types (<code>Fan&lt;In|Out>Shape&lt;arity></code>).</li></ul><p>Simpler graphs can be done using, for example, the simpler <code>Sink.combine</code> API.</p><h2 id=fusion>Fusion
<a class=anchor href=#fusion>#</a></h2><p>By default, Akka &ldquo;fuses&rdquo; all stages onto a single syncronous one to run on a single actor (auto-fusing can be disabled) but this limits the benefits we are looking for.</p><figure><img src=ox-hugo/_20201014_224503screenshot.png></figure><p>In order to add a asyncronous boundary, we just need to add <code>async</code> which disables fusing for that stage, which means that we are adding an additional overhead (Actors, mailboxes and buffers). Its benefits largely depends on the use-case. A good principle is</p><blockquote><ol><li>Insert an async boundary to bisect the stream into two subsections of roughly equal processing time.</li><li>We insert an async boundary to bisect the stream into two subsections of roughly equal processing time.</li></ol></blockquote><p>In other words, check at the current pipeline where the stages can be split so that they can be performed in paralell and joined almost at the same time. This implies looking at Telemetry and verify which stages can be processed in paralell given the graph we have.</p></article><footer class=page-footer></footer><label for=site-menu-control class="hidden site-menu-overlay"></label><label for=content-menu-control class="hidden content-menu-overlay"></label></div><aside class=content-menu><div class=content-menu-content><div class=toc-tags><p class=toc-title>Tags</p><div class=list-item-tag style=background-color:#ffecb3>Akka</div><div class=list-item-tag style=background-color:#d1c4e9>Stream</div></div><p class=toc-title>Table Of Contents</p><nav id=TableOfContents><ul><li><a href=#source>Source</a></li><li><a href=#sink>Sink</a></li><li><a href=#flows>Flows</a></li><li><a href=#runnable-graphs>Runnable Graphs</a></li><li><a href=#fault-tolerancy-todo-review-examples>Fault Tolerancy - TODO: Review Examples</a></li><li><a href=#graphs>Graphs</a></li><li><a href=#fusion>Fusion</a></li></ul></nav><nav class=backlinks><p class=toc-title>Mentioned In</p><ul class=item-preview-list><li><a href=/knowledge-base/notes/reactive_streams/><div class=item-preview><span class=item-preview-title>Reactive Streams</span><br><span class=item-preview-content>Components of a Reactive Stream:
Publisher: Publishes data to stream Subscriber: Consumes â€¦</span></div></a></li></ul></nav></div></aside></main></body></html>