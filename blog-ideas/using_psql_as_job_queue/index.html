<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use-case: Process event queue stored in PSQL:
 Dequeue size item. Process each item.  As expected, resiliency and concurrent systems leads to devious details where the resolution largely depends on the use-case:
 Multiple nodes accessing the same queue. What happens if the node crashes while it processes the item. Will the event loss?  Consider the following table:
DROP TABLE IF EXISTS &#34;queue&#34;; CREATE TABLE &#34;queue&#34; ( &#34;id&#34; SERIAL, &#34;dequeued_at&#34; TIMESTAMP NULL, -- remaining fields relevant for the use-case."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Using PSQL as job queue"><meta property="og:description" content="Use-case: Process event queue stored in PSQL:
 Dequeue size item. Process each item.  As expected, resiliency and concurrent systems leads to devious details where the resolution largely depends on the use-case:
 Multiple nodes accessing the same queue. What happens if the node crashes while it processes the item. Will the event loss?  Consider the following table:
DROP TABLE IF EXISTS &#34;queue&#34;; CREATE TABLE &#34;queue&#34; ( &#34;id&#34; SERIAL, &#34;dequeued_at&#34; TIMESTAMP NULL, -- remaining fields relevant for the use-case."><meta property="og:type" content="article"><meta property="og:url" content="https://bphenriques.github.io/knowledge-base/blog-ideas/using_psql_as_job_queue/"><title>Using PSQL as job queue | Bruno Henriques</title><link rel=manifest href=/knowledge-base/manifest.json><link rel=icon href=/knowledge-base/favicon.png type=image/x-icon><link rel=stylesheet href=/knowledge-base/book.min.19256db6edae397ffaff8a50dfd331f9f5f916ae4720b444fb87a8d48e9a61f0.css integrity="sha256-GSVttu2uOX/6/4pQ39Mx+fX5Fq5HILRE+4eo1I6aYfA="><script defer src=/knowledge-base/en.search.min.0490e49bbe9ce067b22dd7720d8e50a3a998e3585f89ab97a368bba795094000.js integrity="sha256-BJDkm76c4GeyLddyDY5Qo6mY41hfiauXo2i7p5UJQAA="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/knowledge-base><span>Bruno Henriques</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Concurrency</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/concurrency/actor-model/>Actor Model</a></li></ul></li><li class=book-section-flat><span>Data Processing</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/data-processing/apache-spark/>Apache Spark</a></li><li><a href=https://bphenriques.github.io/knowledge-base/data-processing/states-of-data/>States of Data</a></li></ul></li><li class=book-section-flat><span>Documentation</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/documentation/readme/>readme</a></li></ul></li><li class=book-section-flat><span>JVM</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/jvm/jackson/>Jackson</a></li></ul></li><li class=book-section-flat><span>Learning</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/learning/hands_on_scala_programming/>Hands-on Scala Programming</a></li></ul></li><li class=book-section-flat><span>Messaging Systems</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/messaging-systems/overview/>Messaging Systems Comparison</a></li></ul></li><li class=book-section-flat><span>Monitoring</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/monitoring/bug-management/>Bug Management</a></li></ul></li><li class=book-section-flat><span>Reactive Architecture</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/reactive-architecture/patterns/>Patterns</a></li></ul></li><li class=book-section-flat><span>Security</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/security/jwt/>JWT</a></li></ul></li><li class=book-section-flat><span>System Design</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/system-design/consistency_and_availability/>Consistency And Availability</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/distribute_systems/>Distributed Systems</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/domain_driven_design/>Domain Driven Design</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/message_driven_architecture/>Message Driven Architecture</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/microservices/>Microservices</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/monolith/>Monolith</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/service_oriented_architecture/>Service Oriented Architecture</a></li></ul></li><li class=book-section-flat><span>Work</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/work/random-memories/>Random Memories</a></li><li><a href=https://bphenriques.github.io/knowledge-base/work/way-of-work/>Way of work</a></li></ul></li><li class=book-section-flat><span>Snippets</span><ul></ul></li><li class=book-section-flat><span>Blog Ideas</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/blog-ideas/using_psql_as_job_queue/ class=active>Using PSQL as job queue</a></li></ul></li><li class=book-section-flat><span>Uncategorized</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/akka/>Akka</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/lightbend-academy/>Lightbend Academy</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/org_protocol/>Org-Protocol</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/relevant-xkcds/>Relevant xkcds</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/knowledge-base/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Using PSQL as job queue</strong>
<label for=toc-control><img src=/knowledge-base/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents></nav></aside></header><article class=markdown><p>Use-case: Process event queue stored in PSQL:</p><ol><li>Dequeue <code>size</code> item.</li><li>Process each item.</li></ol><p>As expected, resiliency and concurrent systems leads to devious details where the resolution largely depends on the use-case:</p><ul><li>Multiple nodes accessing the same queue.</li><li>What happens if the node crashes while it processes the item. Will the event loss?</li></ul><p>Consider the following table:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;queue&#34;</span>;
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;queue&#34;</span> (
  <span style=color:#e6db74>&#34;id&#34;</span> SERIAL,
  <span style=color:#e6db74>&#34;dequeued_at&#34;</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>NULL</span>,

  <span style=color:#75715e>-- remaining fields relevant for the use-case. For the outbox pattern, one would be storing the event in JSON format, the event id and the event&#39;s timestamp.
</span><span style=color:#75715e></span>);
</code></pre></div><p>This table represent a queue in the database. In order to fetch <code>size</code> elements from the queue:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>UPDATE</span> event_queue <span style=color:#66d9ef>SET</span> dequeued_at <span style=color:#f92672>=</span> <span style=color:#66d9ef>current_timestamp</span>
<span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (
      <span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> queue
      <span style=color:#66d9ef>WHERE</span> dequeued_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>current_timestamp</span> <span style=color:#f92672>&gt;=</span> (dequeued_at <span style=color:#f92672>+</span> interval <span style=color:#e6db74>&#39;1 second&#39;</span> <span style=color:#66d9ef>second</span> <span style=color:#f92672>*</span> :seconds)
      <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> event_timestamp <span style=color:#66d9ef>ASC</span>
      <span style=color:#66d9ef>LIMIT</span> :<span style=color:#66d9ef>size</span>
      <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>UPDATE</span> SKIP LOCKED
)
RETURNING <span style=color:#f92672>*</span>
</code></pre></div><ul><li>One can simplify this to solely fetch one element at at a time but this reduces the connections done in the DB. It depends on the use-case.</li></ul><p>Breaking down:</p><ul><li><code>UPDATE event_queue SET dequeued_at = current_timestamp + ~FOR UPDATE SKIP LOCKED</code> - Guarantees that multiple nodes reading N elements from the queue will have disjoint sets.</li><li><code>WHERE dequeued_at IS NULL</code> - Condition to check if the item was dequeued.</li><li><code>current_timestamp >= (dequeued_at + interval '1 second' second * :seconds)</code> - Guarantees that multiple nodes will not process the same elements.</li></ul><p>Alternatives:</p><ul><li>Just delete the entity, however it incurs the risk if processing the element fails leading to the loss.</li></ul><p>References:</p><ul><li></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><div><a class="flex align-center" href=https://github.com/bphenriques/knowledge-base/edit/master/org/blog-ideas/using_psql_as_job_queue.org target=_blank rel=noopener><img src=/knowledge-base/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents></nav></aside></main></body></html>