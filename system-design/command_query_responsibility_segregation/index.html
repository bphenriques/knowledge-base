<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Referred in
 Event Sourcing   Eventually consistent by design which always present but now is explicit about it.
Some Aggregate Roots are a better fit for write models but do not fit other read models. Requirements for both models are different.
Command Query Responsibility Segregation (CQRS) aims to separate read models from write models. This is specially problematic when using Event Sourcing. Note that Event Sourcing is not a requirement for CQRS but are often combined."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Command Query Responsibility Segregation (CQRS)"><meta property="og:description" content="Referred in
 Event Sourcing   Eventually consistent by design which always present but now is explicit about it.
Some Aggregate Roots are a better fit for write models but do not fit other read models. Requirements for both models are different.
Command Query Responsibility Segregation (CQRS) aims to separate read models from write models. This is specially problematic when using Event Sourcing. Note that Event Sourcing is not a requirement for CQRS but are often combined."><meta property="og:type" content="article"><meta property="og:url" content="https://bphenriques.github.io/knowledge-base/system-design/command_query_responsibility_segregation/"><title>Command Query Responsibility Segregation (CQRS) | Bruno Henriques</title><link rel=manifest href=/knowledge-base/manifest.json><link rel=icon href=/knowledge-base/favicon.png type=image/x-icon><link rel=stylesheet href=/knowledge-base/book.min.1251f5eefcf487ae0df4b5a44283e1e26687a9e19d3af75df0afe44c4689ad10.css integrity="sha256-ElH17vz0h64N9LWkQoPh4maHqeGdOvdd8K/kTEaJrRA="><script defer src=/knowledge-base/en.search.min.18c4f1bb35d496d040165205a05fd49be37ad66138c3556669bccc64aa1f0d28.js integrity="sha256-GMTxuzXUltBAFlIFoF/Um+N61mE4w1VmabzMZKofDSg="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/knowledge-base><span>Bruno Henriques</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>Concurrency</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/concurrency/actor-model/>Actor Model</a></li></ul></li><li class=book-section-flat><span>Data Processing</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/data-processing/apache-spark/>Apache Spark</a></li><li><a href=https://bphenriques.github.io/knowledge-base/data-processing/states-of-data/>States of Data</a></li></ul></li><li class=book-section-flat><span>Databases</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/databases/overview/>Overview</a></li></ul></li><li class=book-section-flat><span>Documentation</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/documentation/readme/>Readme</a></li></ul></li><li class=book-section-flat><span>Editors</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/editors/emacs/>Emacs</a></li></ul></li><li class=book-section-flat><span>Learning</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/learning/coursera/>Coursera</a></li><li><a href=https://bphenriques.github.io/knowledge-base/learning/hands_on_scala_programming/>Hands-on Scala Programming</a></li><li><a href=https://bphenriques.github.io/knowledge-base/learning/technical_writing/>Technical Writing</a></li></ul></li><li class=book-section-flat><span>Messaging Systems</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/messaging-systems/messaging-overview/>Messaging Systems Comparison</a></li><li><a href=https://bphenriques.github.io/knowledge-base/messaging-systems/messaging-systems-overview/>Messaging Systems Comparison</a></li></ul></li><li class=book-section-flat><span>Monitoring</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/monitoring/bug-management/>Bug Management</a></li></ul></li><li class=book-section-flat><span>Resources</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/resources/design/>Design</a></li></ul></li><li class=book-section-flat><span>Security</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/security/jwt/>JWT</a></li></ul></li><li class=book-section-flat><span>System Design</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/system-design/command_query_responsibility_segregation/ class=active>Command Query Responsibility Segregation (CQRS)</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/command_sourcing/>Command Sourcing</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/consistency_and_availability/>Consistency And Availability</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/cqrs_es/>CQRS/ES</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/domain_driven_design/>Domain Driven Design</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/event_sourcing/>Event Sourcing</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/message_driven_architecture/>Message Driven Architecture</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/microservices/>Microservices</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/monolith/>Monolith</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/reactive_systems/>Reactive Systems</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/service_oriented_architecture/>Service Oriented Architecture</a></li><li><a href=https://bphenriques.github.io/knowledge-base/system-design/articles/>System Design Articles</a></li></ul></li><li class=book-section-flat><span>Work</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/work/curriculum/>Curriculum</a></li><li><a href=https://bphenriques.github.io/knowledge-base/work/random-memories/>Random Memories</a></li><li><a href=https://bphenriques.github.io/knowledge-base/work/way-of-work/>Way of work</a></li></ul></li><li class=book-section-flat><span>Snippets</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/snippets/emacs/>Emacs</a></li><li><a href=https://bphenriques.github.io/knowledge-base/snippets/jackson/>Jackson</a></li></ul></li><li class=book-section-flat><span>Blog Ideas</span><ul></ul></li><li class=book-section-flat><span>Uncategorized</span><ul><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/akka/>Akka</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/dotfiles/>dotfiles</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/event_sourcing/>Event Sourcing</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/lightbend-academy/>Lightbend Academy</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__/>Linux Tips</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/nix/>Nix</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/org_protocol/>Org-Protocol</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/relevant-xkcds/>Relevant xkcds</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__ssh_agent_explained/>SSH Agent</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-stack-enties/>Stack Web Notes</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__degoogle_a_huge_list_of_alternatives_to_google_products_privacy_tips_tricks_and_links/>Web Note - degoogle | A huge list of alternatives to Google products. Privacy tips, tricks, and links.</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__remembering_what_you_read_zettelkasten_vs_p_a_r_a/>Web Note - Remembering what you Read: Zettelkasten vs P.A.R.A.</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__stop_taking_regular_notes_use_a_zettelkasten_instead_hacker_news/>Web Note - Stop Taking Regular Notes; Use a Zettelkasten Instead | Hacker News</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__the_product_minded_software_engineer_the_pragmatic_engineer/>Web Note - The Product-Minded Software Engineer - The Pragmatic Engineer</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__tools_for_better_thinking_untools/>Web Note - Tools for better thinking | Untools</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__what_is_nix_shopify_engineering/>Web Note - What Is Nix – Shopify Engineering</a></li><li><a href=https://bphenriques.github.io/knowledge-base/uncategorized/web-note__write_code_that_is_easy_to_delete_not_easy_to_programming_is_terrible/>Web Note - Write code that is easy to delete, not easy to… — programming is terrible</a></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/knowledge-base/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Command Query Responsibility Segregation (CQRS)</strong>
<label for=toc-control><img src=/knowledge-base/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#how>How:</a></li><li><a href=#summary>Summary</a></li><li><a href=#models-as-microservices>Models as Microservices</a></li><li><a href=#consistency>Consistency</a><ul><li><a href=#write-model>Write Model</a></li><li><a href=#read-model>Read Model</a></li></ul></li><li><a href=#availability>Availability</a><ul><li><a href=#write-model>Write Model</a></li><li><a href=#read-model>Read Model</a></li></ul></li><li><a href=#cost>Cost</a></li></ul></nav></aside></header><article class=markdown><div class=backlinks><div></div><p>Referred in</p><ul><li><a href=/knowledge-base/system-design/event_sourcing/>Event Sourcing</a></li></ul></div><p>Eventually consistent by design which always present but now is explicit about it.</p><p>Some Aggregate Roots are a better fit for write models but do not fit other read models. Requirements for both models are different.</p><p>Command Query Responsibility Segregation (CQRS) aims to separate read models from write models. This is specially problematic when using <a href=/knowledge-base/system-design/event_sourcing/>Event Sourcing</a>. Note that <a href=/knowledge-base/system-design/event_sourcing/>Event Sourcing</a> is not a requirement for CQRS but are often combined.</p><h2 id=how>How:
<a class=anchor href=#how>#</a></h2><pre><code class=language-nil data-lang=nil>API -Queries-&gt; Read Model &lt;- Data Store
API -Commands-&gt; Write Model -&gt; Data Store
</code></pre><p>Notes:</p><ul><li>There can be multiple read models to satisfy different use-cases.</li></ul><p>Each model is optimized for their purpose.</p><p>Separate process consumes the written events and persists on a denormalized event store, which is called <em>Projection</em> used by the read model like so:</p><pre><code class=language-nil data-lang=nil>API -Queries-&gt; Read Model &lt;- Data Store
API -Commands-&gt; Write Model -&gt; Data Store

Data Store -Events-&gt; Denormalized Data Store (with Projections)
</code></pre><p>Denormalization makes queries fast as there is no need for complex joins or queries.</p><h2 id=summary>Summary
<a class=anchor href=#summary>#</a></h2><ul><li>Flexible model</li><li>Write model are optimized for writes</li><li>Read models are optimized for reads</li><li>Read and write models are decoupled which implies that they may use different data stores.</li><li>New <em>Projections</em> are easy in CQRD/ES.</li><li>New projections are retroactive because we have the fully history.</li></ul><h2 id=models-as-microservices>Models as Microservices
<a class=anchor href=#models-as-microservices>#</a></h2><ul><li>Write Model can become a microservice</li><li>Read Model can become a microservice</li></ul><p>This assumes that it uses different databases (as expected from proper microservices). Otherwise the database may become the bottleneck.</p><p>Better yet: Each projection in its own Microservice. \[\]\[\]\[\] and maintentance.</p><h2 id=consistency>Consistency
<a class=anchor href=#consistency>#</a></h2><p>Simple (without ES) has the same consistency as non-CQRS systems.
CQRD/ES can have different consistency models for the read or the write models.</p><h3 id=write-model>Write Model
<a class=anchor href=#write-model>#</a></h3><p>Strong is often important here because we want that those write be based on the current state. This consistency is usually implemented through locks or sharding in a more reactive way.</p><h3 id=read-model>Read Model
<a class=anchor href=#read-model>#</a></h3><p>Pure reads are never consistent as they are often working with stale data. These reads do not need strong consistency.</p><h2 id=availability>Availability
<a class=anchor href=#availability>#</a></h2><h3 id=write-model>Write Model
<a class=anchor href=#write-model>#</a></h3><p>Due to the higher consistency, availability is lower</p><h3 id=read-model>Read Model
<a class=anchor href=#read-model>#</a></h3><p>Due to the eventual consistency, we can leverage technicques to increase availability.</p><h2 id=cost>Cost
<a class=anchor href=#cost>#</a></h2><p>CQRD/ES is often criticized for being more complex but it can be simpler.
Without this, models are more bloated, complex and rigid.
CQRD allow smaller models that are easier to modify and understand.
Eventual consistency in CQRS can be isolated to where it is necessary.</p><ul><li>More databases to maintain</li><li>More classes/objects to maintain</li><li>Support older versions can be challenging</li><li>Additinoal storage</li><li>Data duplication may result in desyncs that often solved by rebuilding project - Question: <strong>when</strong> ? Do we have monitoring over this? Can this be automatic? How often does this occur?</li><li>UI must be designed to be eventually consistent (which was always there in the past, it is now explicit)</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><div><a class="flex align-center" href=https://github.com/bphenriques/knowledge-base/edit/master/org/system-design/command_query_responsibility_segregation.org target=_blank rel=noopener><img src=/knowledge-base/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#how>How:</a></li><li><a href=#summary>Summary</a></li><li><a href=#models-as-microservices>Models as Microservices</a></li><li><a href=#consistency>Consistency</a><ul><li><a href=#write-model>Write Model</a></li><li><a href=#read-model>Read Model</a></li></ul></li><li><a href=#availability>Availability</a><ul><li><a href=#write-model>Write Model</a></li><li><a href=#read-model>Read Model</a></li></ul></li><li><a href=#cost>Cost</a></li></ul></nav></aside></main></body></html>