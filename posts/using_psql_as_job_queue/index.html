<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use-case: Fault Tolerant event queue in Postgres.
Consider the following table:
DROP TABLE IF EXISTS &#34;queue&#34;; CREATE TABLE &#34;queue&#34; ( &#34;id&#34; SERIAL, &#34;dequeued_at&#34; TIMESTAMP NULL, -- remaining fields relevant for the use-case. For the outbox pattern, one would be storing the event in JSON format, the event id and the event's timestamp. ); This table represent a queue in the database. In order to fetch size elements from the queue:"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Using PSQL as job queue"><meta property="og:description" content="Use-case: Fault Tolerant event queue in Postgres.
Consider the following table:
DROP TABLE IF EXISTS &#34;queue&#34;; CREATE TABLE &#34;queue&#34; ( &#34;id&#34; SERIAL, &#34;dequeued_at&#34; TIMESTAMP NULL, -- remaining fields relevant for the use-case. For the outbox pattern, one would be storing the event in JSON format, the event id and the event's timestamp. ); This table represent a queue in the database. In order to fetch size elements from the queue:"><meta property="og:type" content="article"><meta property="og:url" content="https://bphenriques.github.io/knowledge-base/posts/using_psql_as_job_queue/"><meta property="article:section" content="posts"><title>Using PSQL as job queue | Bruno Henriques's Digital Garden ðŸŒ±</title><link rel=icon href=/knowledge-base/favicon.png type=image/x-icon><link rel=stylesheet href=/knowledge-base/scss/explorer.min.81227fe14d47ca25b022b9b15feec75f9eb2a749e8453568ef9edad255a06da9.css integrity="sha256-gSJ/4U1HyiWwIrmxX+7HX56yp0noRTVo757a0lWgbak=" crossorigin=anonymous><script defer src=/knowledge-base/js/vendor/flexsearch.bundle.js></script><script defer src=/knowledge-base/js/search.min.f194e85d309adae058282f0ea2266359fe8ec0a80095467ac13c18625cd3a197.js integrity="sha256-8ZToXTCa2uBYKC8OoiZjWf6OwKgAlUZ6wTwYYlzToZc=" crossorigin=anonymous></script><script defer src=/knowledge-base/js/clipboard.min.14b9ccf5803971502776b44d95026b084e5fa02a544dc0e4cd86a7db76f691b2.js integrity="sha256-FLnM9YA5cVAndrRNlQJrCE5foCpUTcDkzYan23b2kbI=" crossorigin=anonymous></script></head><body><input type=checkbox class="hidden toggle" id=site-menu-control>
<input type=checkbox class="hidden toggle" id=content-menu-control><main class="container flex"><aside class=site-menu><div class=site-menu-content><nav><h2 class=brand><a class="flex align-center" href=/knowledge-base/><span>Bruno Henriques</span></a></h2><div class=search><input type=text id=search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="search-spinner hidden"></div><ul id=search-results class=item-preview-list></ul></div><a class=site-menu-shortcut-link href=/knowledge-base/notes>Recent Notes</a><p class=site-menu-tags-title><b>Tags</b></p><ul><li><a class=list-tag-item href=/knowledge-base/tags/akka><div class=tag-dot style=background-color:#ffecb3></div>Akka</a></li><li><a class=list-tag-item href=/knowledge-base/tags/aws><div class=tag-dot style=background-color:#f5f5f5></div>Aws</a></li><li><a class=list-tag-item href=/knowledge-base/tags/concurrency><div class=tag-dot style=background-color:#f5f5f5></div>Concurrency</a></li><li><a class=list-tag-item href=/knowledge-base/tags/data><div class=tag-dot style=background-color:#ffe0b2></div>Data</a></li><li><a class=list-tag-item href=/knowledge-base/tags/data-structures><div class=tag-dot style=background-color:#ffcdd2></div>Data structures</a></li><li><a class=list-tag-item href=/knowledge-base/tags/databases><div class=tag-dot style=background-color:#f1f8e9></div>Databases</a></li><li><a class=list-tag-item href=/knowledge-base/tags/dispatcher><div class=tag-dot style=background-color:#c8e6c9></div>Dispatcher</a></li><li><a class=list-tag-item href=/knowledge-base/tags/docker><div class=tag-dot style=background-color:#b9f6ca></div>Docker</a></li><li><a class=list-tag-item href=/knowledge-base/tags/docker-compose><div class=tag-dot style=background-color:#ffe0b2></div>Docker compose</a></li><li><a class=list-tag-item href=/knowledge-base/tags/dotfiles><div class=tag-dot style=background-color:#ab9df2></div>Dotfiles</a></li><li><a class=list-tag-item href=/knowledge-base/tags/editors><div class=tag-dot style=background-color:#ffb74d></div>Editors</a></li><li><a class=list-tag-item href=/knowledge-base/tags/flakes><div class=tag-dot style=background-color:#c8e6c9></div>Flakes</a></li><li><a class=list-tag-item href=/knowledge-base/tags/functional-programming><div class=tag-dot style=background-color:#ffebee></div>Functional programming</a></li><li><a class=list-tag-item href=/knowledge-base/tags/jq><div class=tag-dot style=background-color:#e1f5fe></div>Jq</a></li><li><a class=list-tag-item href=/knowledge-base/tags/json><div class=tag-dot style=background-color:#ffebee></div>JSON</a></li><li><a class=list-tag-item href=/knowledge-base/tags/jvm><div class=tag-dot style=background-color:#90caf9></div>Jvm</a></li><li><a class=list-tag-item href=/knowledge-base/tags/kotlin><div class=tag-dot style=background-color:#ffe57f></div>Kotlin</a></li><li><a class=list-tag-item href=/knowledge-base/tags/lightbend><div class=tag-dot style=background-color:#f0f4c3></div>Lightbend</a></li><li><a class=list-tag-item href=/knowledge-base/tags/monitoring><div class=tag-dot style=background-color:#e3f2fd></div>Monitoring</a></li><li><a class=list-tag-item href=/knowledge-base/tags/nix><div class=tag-dot style=background-color:#c5e1a5></div>Nix</a></li><li><a class=list-tag-item href=/knowledge-base/tags/note><div class=tag-dot style=background-color:#bbdefb></div>Note</a></li><li><a class=list-tag-item href=/knowledge-base/tags/postgres><div class=tag-dot style=background-color:#b2dfdb></div>Postgres</a></li><li><a class=list-tag-item href=/knowledge-base/tags/protocols><div class=tag-dot style=background-color:#ab9df2></div>Protocols</a></li><li><a class=list-tag-item href=/knowledge-base/tags/psql><div class=tag-dot style=background-color:#e0f2f1></div>Psql</a></li><li><a class=list-tag-item href=/knowledge-base/tags/queue><div class=tag-dot style=background-color:#ffebee></div>Queue</a></li><li><a class=list-tag-item href=/knowledge-base/tags/reference><div class=tag-dot style=background-color:#00bfa5></div>Reference</a></li><li><a class=list-tag-item href=/knowledge-base/tags/router><div class=tag-dot style=background-color:#c8e6c9></div>Router</a></li><li><a class=list-tag-item href=/knowledge-base/tags/scala><div class=tag-dot style=background-color:#ffd180></div>Scala</a></li><li><a class=list-tag-item href=/knowledge-base/tags/security><div class=tag-dot style=background-color:#b3e5fc></div>Security</a></li><li><a class=list-tag-item href=/knowledge-base/tags/signing><div class=tag-dot style=background-color:#ffd866></div>Signing</a></li><li><a class=list-tag-item href=/knowledge-base/tags/snippets><div class=tag-dot style=background-color:#e1f5fe></div>Snippets</a></li><li><a class=list-tag-item href=/knowledge-base/tags/stream><div class=tag-dot style=background-color:#d1c4e9></div>Stream</a></li><li><a class=list-tag-item href=/knowledge-base/tags/system-design><div class=tag-dot style=background-color:#ffebee></div>System design</a></li><li><a class=list-tag-item href=/knowledge-base/tags/testing><div class=tag-dot style=background-color:#e0e0e0></div>Testing</a></li><li><a class=list-tag-item href=/knowledge-base/tags/work><div class=tag-dot style=background-color:#f5f5f5></div>Work</a></li><li><a class=list-tag-item href=/knowledge-base/tags/zettelkasten><div class=tag-dot style=background-color:#e3f2fd></div>Zettelkasten</a></li></ul></nav></div></aside><div class=page><header class=mobile-navigation-header><div class="flex align-center justify-between"><label for=site-menu-control><img src=/knowledge-base/svg/menu-page.svg class=icon alt="Page Menu"></label>
<strong>Using PSQL as job queue</strong>
<label for=content-menu-control><img src=/knowledge-base/svg/menu-content.svg class=icon alt="Content Menu"></label></div></header><article class=markdown><h1 class=post-title><a href=/knowledge-base/posts/using_psql_as_job_queue/>Using PSQL as job queue</a></h1><p>Use-case: Fault Tolerant event queue in Postgres.</p><p>Consider the following table:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#e6db74>&#34;queue&#34;</span>;
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#e6db74>&#34;queue&#34;</span> (
  <span style=color:#e6db74>&#34;id&#34;</span> SERIAL,
  <span style=color:#e6db74>&#34;dequeued_at&#34;</span> <span style=color:#66d9ef>TIMESTAMP</span> <span style=color:#66d9ef>NULL</span>,

  <span style=color:#75715e>-- remaining fields relevant for the use-case. For the outbox pattern, one would be storing the event in JSON format, the event id and the event&#39;s timestamp.
</span><span style=color:#75715e></span>);
</code></pre></div><p>This table represent a queue in the database. In order to fetch <code>size</code> elements from the queue:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>UPDATE</span> event_queue <span style=color:#66d9ef>SET</span> dequeued_at <span style=color:#f92672>=</span> <span style=color:#66d9ef>current_timestamp</span>
<span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (
      <span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> queue
      <span style=color:#66d9ef>WHERE</span> dequeued_at <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>current_timestamp</span> <span style=color:#f92672>&gt;=</span> (dequeued_at <span style=color:#f92672>+</span> interval <span style=color:#e6db74>&#39;1 second&#39;</span> <span style=color:#66d9ef>second</span> <span style=color:#f92672>*</span> :seconds)
      <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> event_timestamp <span style=color:#66d9ef>ASC</span>
      <span style=color:#66d9ef>LIMIT</span> :<span style=color:#66d9ef>size</span>
      <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>UPDATE</span> SKIP LOCKED
)
RETURNING <span style=color:#f92672>*</span>
</code></pre></div><p>Breaking down:</p><ul><li><code>UPDATE event_queue SET dequeued_at = current_timestamp + ~FOR UPDATE SKIP LOCKED</code> - Guarantees that multiple nodes reading N elements from the queue will have disjoint sets.</li><li><code>WHERE dequeued_at IS NULL</code> - Check if the item was already or not dequeued.</li><li><code>current_timestamp >= (dequeued_at + interval '1 second' second * :seconds)</code> - Guarantees that multiple nodes will not process the same elements. Does <code>SKIP LOCKED</code> already safe-guards this?</li></ul></article><footer class=page-footer></footer><label for=site-menu-control class="hidden site-menu-overlay"></label><label for=content-menu-control class="hidden content-menu-overlay"></label></div><aside class=content-menu><div class=content-menu-content><div class=toc-tags><p class=toc-title>Tags</p><div class=list-item-tag style=background-color:#e0f2f1>Psql</div><div class=list-item-tag style=background-color:#ffebee>Queue</div></div><p class=toc-title>Table Of Contents</p><nav id=TableOfContents></nav></div></aside></main></body></html>